name: Nekoo Host - Account 2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6,18 * * *'  # 6 AM and 6 PM UTC

jobs:
  host:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
      
      - name: Build Nekoo
        run: |
          source $HOME/.cargo/env
          cargo build --release
      
      - name: Setup Database
        run: touch nekoo.db
      
      - name: Start Nekoo Application
        env:
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
        run: |
          source $HOME/.cargo/env
          ./target/release/nekoo &
          sleep 10
      
      - name: Setup Cloudflare Tunnel
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          ./cloudflared-linux-amd64 tunnel --no-autoupdate run --token $TUNNEL_TOKEN &
          sleep 21600
