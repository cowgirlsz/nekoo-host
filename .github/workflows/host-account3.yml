name: Nekoo Host - Account 3

on:
  workflow_dispatch:
  schedule:
    - cron: '36 9 * * *'  # 09:36 UTC

jobs:
  host:
    runs-on: ubuntu-latest
    timeout-minutes: 340
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustc --version
      
      - name: Build Nekoo
        run: |
          source $HOME/.cargo/env
          cargo build --release
          ls -lh target/release/nekoo
      
      - name: Setup Database
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          mkdir -p temp_uploads
          
          echo "Attempting to restore database from backup..."
          DOWNLOAD_URL=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/avi8427/nekoo-host/releases/tags/db-backup" \
            | jq -r '.assets[] | select(.name == "nekoo.db") | .url')
          
          if [ "$DOWNLOAD_URL" != "" ] && [ "$DOWNLOAD_URL" != "null" ]; then
            curl -s -L -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/octet-stream" \
              "$DOWNLOAD_URL" -o nekoo.db
            DB_SIZE=$(stat -c%s nekoo.db 2>/dev/null || echo "0")
            echo "✅ Database restored from backup ($DB_SIZE bytes)"
          else
            echo "⚠️ No backup found, starting fresh"
            touch nekoo.db
          fi
      
      - name: Create .env file
        env:
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
        run: |
          echo "ADMIN_KEY=$ADMIN_KEY" > .env
          echo "RUST_LOG=nekoo=info" >> .env
      
      - name: Start Services
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          
          source $HOME/.cargo/env
          nohup ./target/release/nekoo > nekoo.log 2>&1 &
          NEKOO_PID=$!
          
          sleep 5
          if kill -0 $NEKOO_PID 2>/dev/null; then
            echo "✅ Nekoo is running (PID: $NEKOO_PID)"
          else
            echo "❌ Nekoo failed to start"
            cat nekoo.log
            exit 1
          fi
          
          sleep 2
          curl -s http://localhost:3000/health || echo "Health check failed"
          head -20 nekoo.log
          
          nohup ./cloudflared-linux-amd64 tunnel --no-autoupdate run --token $TUNNEL_TOKEN > tunnel.log 2>&1 &
          TUNNEL_PID=$!
          echo "✅ Cloudflare Tunnel started (PID: $TUNNEL_PID)"
          sleep 10
          head -20 tunnel.log
          
          backup_db() {
            local RELEASE_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/avi8427/nekoo-host/releases/tags/db-backup" | jq -r '.id')
            if [ "$RELEASE_ID" != "null" ] && [ "$RELEASE_ID" != "" ]; then
              local OLD_ASSET=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/avi8427/nekoo-host/releases/$RELEASE_ID/assets" \
                | jq -r '.[] | select(.name == "nekoo.db") | .id')
              if [ "$OLD_ASSET" != "" ] && [ "$OLD_ASSET" != "null" ]; then
                curl -s -X DELETE -H "Authorization: token $GH_TOKEN" \
                  "https://api.github.com/repos/avi8427/nekoo-host/releases/assets/$OLD_ASSET"
              fi
              curl -s -X POST -H "Authorization: token $GH_TOKEN" \
                -H "Content-Type: application/octet-stream" \
                "https://uploads.github.com/repos/avi8427/nekoo-host/releases/$RELEASE_ID/assets?name=nekoo.db" \
                --data-binary @nekoo.db > /dev/null
              echo "[$(date)] ✅ Database backed up"
            fi
          }
          
          echo "Services running. Starting monitoring loop..."
          BACKUP_COUNTER=0
          for i in {1..340}; do
            sleep 60
            if ! kill -0 $NEKOO_PID 2>/dev/null; then
              echo "❌ Nekoo died!"; tail -50 nekoo.log; backup_db; exit 1
            fi
            if ! kill -0 $TUNNEL_PID 2>/dev/null; then
              echo "❌ Tunnel died!"; tail -50 tunnel.log; backup_db; exit 1
            fi
            BACKUP_COUNTER=$((BACKUP_COUNTER + 1))
            if [ $((BACKUP_COUNTER % 5)) -eq 0 ]; then backup_db; fi
            if [ $((i % 30)) -eq 0 ]; then
              echo "[$i min] Services running. Nekoo PID: $NEKOO_PID, Tunnel PID: $TUNNEL_PID"
            fi
          done
          echo "Session ending, final backup..."
          backup_db
