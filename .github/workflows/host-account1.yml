name: Nekoo Host - Account 1

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0,12 * * *'  # Midnight and noon UTC

jobs:
  host:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustc --version
      
      - name: Build Nekoo
        run: |
          source $HOME/.cargo/env
          cargo build --release
          ls -lh target/release/nekoo
      
      - name: Setup Database
        run: |
          touch nekoo.db
          mkdir -p temp_uploads
          
      - name: Create .env file
        env:
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
        run: |
          echo "ADMIN_KEY=$ADMIN_KEY" > .env
          echo "RUST_LOG=nekoo=info" >> .env
      
      - name: Start Services
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          # Download cloudflared
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          
          # Start Nekoo in background
          source $HOME/.cargo/env
          nohup ./target/release/nekoo > nekoo.log 2>&1 &
          NEKOO_PID=$!
          echo "Nekoo PID: $NEKOO_PID"
          
          # Wait for app to start
          sleep 5
          
          # Check if Nekoo is running
          if kill -0 $NEKOO_PID 2>/dev/null; then
            echo "✅ Nekoo is running (PID: $NEKOO_PID)"
          else
            echo "❌ Nekoo failed to start"
            cat nekoo.log
            exit 1
          fi
          
          # Test local connection
          sleep 2
          curl -s http://localhost:3000/health || echo "Health check failed"
          
          # Show first few log lines
          echo "=== Nekoo Logs ==="
          head -20 nekoo.log
          
          # Start Cloudflare Tunnel
          nohup ./cloudflared-linux-amd64 tunnel --no-autoupdate run --token $TUNNEL_TOKEN > tunnel.log 2>&1 &
          TUNNEL_PID=$!
          echo "✅ Cloudflare Tunnel started (PID: $TUNNEL_PID)"
          
          # Wait a bit for tunnel to connect
          sleep 10
          echo "=== Tunnel Logs ==="
          head -20 tunnel.log
          
          # Keep both services alive for 6 hours
          echo "Services running. Keeping alive for 6 hours..."
          for i in {1..360}; do
            sleep 60
            # Check if processes are still running
            if ! kill -0 $NEKOO_PID 2>/dev/null; then
              echo "❌ Nekoo died! Logs:"
              tail -50 nekoo.log
              exit 1
            fi
            if ! kill -0 $TUNNEL_PID 2>/dev/null; then
              echo "❌ Tunnel died! Logs:"
              tail -50 tunnel.log
              exit 1
            fi
            # Log status every 10 minutes
            if [ $((i % 10)) -eq 0 ]; then
              echo "[$i min] Services still running. Nekoo PID: $NEKOO_PID, Tunnel PID: $TUNNEL_PID"
            fi
          done
